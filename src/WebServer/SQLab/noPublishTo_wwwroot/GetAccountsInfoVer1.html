<!DOCTYPE html>
<html style="background: linear-gradient(to right, #3080c7, #3080c7 4%, #75e0e1 45%, #73e5e1 55%, #91d73a 97%); background-attachment: fixed;">

<head>
    <meta charset="utf-8" />
    <title>Br.Acc.Info,v1.0</title>
    <link rel="icon" href="data:,"> <!--to prevent favicon.ico requests-->

    <link rel="stylesheet" type="text/css" href="/css/SQStudiesList.css">
    <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>

    <script>
        console.log("Script in Header1.");
        accInfos=[{"AccInfosToBeReplaced":"ByWebserver"}]
    </script>

</head>
<body>
    <h1>IntBrokers Accounts Info (<span id="idBrAccounts"></span>),v1.0 <font size="1" color=#FF0000><a href="ForceReloadUrlToBeReplaced"><span title="Force-Refresh: Disable website cached values."><b>
    <img src="/images/Refresh64.png" height="20" width="20" align="top" /></b></span></a></font></h1>
    <small>Data timestamp: <font size="4" color=#0000FF><b><span id="idTimestamp"></b></span> </font> </small>
    <hr>
    <font size="5" color=#FF0000><b><span id="idMessageFromWebserverIfAny"></span></b></font>
    IB Total NetLiquidation (with cash): <font size="4"><b><span id="idTotalNetLiquidation"></span></b></font><br>
    IB Total Cash: <span id="idTotalCash"></span>/
    IB Initial MarginReq: <span id="idTotalInitMarginReq"></span>/
    IB Maintenance MarginReq: <span id="idTotalMaintMarginReq"></span>/
    IB Gross Position Value: <span id="idTotalGrossPosValue"></span><br>
    <hr>
    Long Stock MktValue: <b><span id="idLongStockValue"></span></b>  <small><i>_____(!! This is not the ?Bullish? Market stock exposure. 'Short VXXB', 'short SH' are market bullish, but not here. Long VXX is here, although it is market bearish. How to fix that?)</i></small> <br>
    Short Stock MktValue: <b><span id="idShortStockValue"></span></b><br>

    <hr style="height:2pt; margin:0px; visibility:hidden;" />   <!--a very thin separator-->
    Call Option Delta Adjusted DelivValue <font size="2"><i>(Long market if GameChangers)</i></font>: <b><span id="idAdjLongOptionValue"></span></b><br>
    Put Option Delta Adjusted DelivValue <font size="2"><i>(<b><font size="3">Hedges</font></b> if QQQ Put)</i></font>: <b><span id="idAdjShortOptionValue"></span></b><br>
    <hr>
    <span title="This is probably a useless number." style="font: large sans-serif">Bullish/Bearish Market Orientation, ver1 <font size="2">(LongStock - ShortStock + Adj.CallOption - Adj.PutOption)</font>: <font size="4"><b><span id="idTotalMarketOrientation"></span></b></font> </span><br>
    <span title="If All (even hedges) goes against you. Use this for leverage calculation." style="font: x-large sans-serif">Max Risked Estimate <font size="2">(LongStk + ShortStk (incorrect! Infinite) + LongOptMktValue + ShortOptMktValue(incorrect! Infinite))</font>: <font size="4" color=#0000FF><b><span id="idTotalMaxRisked"></span></b></font> </span><br>
    <span title="Expect this Beta exposure to QQQ. If QQQ goes up 1%, expect this exposure to go up 1%." style="font: x-large sans-serif">Beta-Delta Adjusted Bullish/Bearish Market Orientation <font size="2">(approx. mkt exposure sum)</font>: <font size="4" color=#0000FF><b><span id="idBetaDeltaAdjTotalMarketOrientation"></span></b></font> </span><br>
    <hr>
    <small><i>[need a DB list of long symbol's bullishness]</i></small><br>
    <font size="1">
        GrossStockExposure (LongStock - Short Stock): <b><span id="idGrossStockExposure"></span></b> and Leverage: <b><span id="idGrossStockExposureLeverage"></span></b><br>
        Delta Adjusted GrossOptionExposure (Long - Short / Call - Put): <b><span id="idAdjGrossOptionExposure"></span></b><br>
        Long Option DelivValue: <b><span id="idLongOptionValue"></span></b>  <small><i>_____(!! Far OTM DelivValue is also summed. On top of the stock bullishness determination problem. How to fix that?)</i></small> <br>
        Short Option DelivValue: <b><span id="idShortOptionValue"></span></b><br>
    </font>

    <hr>
    <table id="idPosTable">
        <!--<tr><th>Symbol &#8661;</th><th>LocalSymbol &#8661;</th><th>Pos &#8661;</th><th>AvgCost &#8661;</th><th>EstPrice &#8661;</th><th>MktValue &#8661;</th><th>EstUnderlPr &#8661;</th><th>DelivValue &#8661;</th></tr>
        <tr><td>2013-04-12</td><td>2013-04-12</td></tr>
        <tr><td>2013-04-17</td><td>2013-04-17</td></tr>
        <tr class="secpri"><td>2013-04-30</td><td>2013-04-30</td></tr>-->
    </table>

    <hr>
    
    <div id="idDebugInfoDiv">
        <small>
            <span id="idDebugInfoSpan">
                Data in JSON:
                <pre id="idDebugInfoPre"> </pre>
                <br>
            </span>
        </small>
    </div>

    <script>
        console.log("Script in Body1.");
        var round = Math.round;

        var betaArr = {"QQQ": 1.0, "TQQQ": 3.0, "SPY": 0.8, "TWM": -1,            // market ETFs
        "VXXB": -2,  "VXZB": -1,  "SVXY": 1, "ZIV": 1,                  // VIX
        "TLT": -0.5, "TMF": "-1.5", "TIP": -0.3, "USO": 0.5, "UWT": 1.5, "UNG": 0.5, "UGAZ": 1.5,                            // HL hedges
        "PM": 0.6 };     // it is QQQ Beta, not SPY beta                // companies

        brAccounts = "", timestamps = "";
        totalNetLiquidation = 0.0, totalCash = 0.0, totalInitMarginReq = 0.0, totalMaintMarginReq = 0.0, totalGrossPosValue = 0.0;
        longStockValue = 0.0, shortStockValue = 0.0;
        longOptionValue = 0.0, shortOptionValue = 0.0;
        adjLongOptionValue = 0.0, adjShortOptionValue = 0.0;
        totalMaxRiskedN = 0.0;
        betaDeltaAdjTotalMarketOrientationN = 0.0;
        posTableInner = "<tr><th>Symbol &#8661;</th><th>LocalSymbol &#8661;</th><th>Pos &#8661;</th><th>AvgCost &#8661;</th><th>EstPrice &#8661;</th><th>P&L &#8661;</th><th>MktValue &#8661;</th><th>Est &#8661;<br/>UnderlPr </th><th>IbComp<br/>UndPr &#8661;</th><th>IbComp<br/>Delta &#8661;</th><th>DelivValue &#8661;</th><th>DeltaAdj &#8661;<br/>DelivValue</th><th title=\"Guessed Beta (QQQ, 1 month)\">gBeta &#8661;</th><th>BetaDeltaAdj &#8661;<br/>MktOrientVal</th><th>Acc &#8661;</th></tr>";
        for (i in accInfos) {
            if (i == "Message") {
                document.getElementById("idMessageFromWebserverIfAny").innerHTML = accInfos[i];
                if (accInfos[i].startsWith("Error"))    // if Message is a Warning or Info, process it. If it is an Error, don't process it further.
                    break;
            } else if (i == 0) {
                brAccounts += accInfos[i].BrAcc;
                timestamps += accInfos[i].Timestamp;
            } else {
                brAccounts += ", " + accInfos[i].BrAcc;
                timestamps += ", " + accInfos[i].Timestamp;
            }

            accSums = accInfos[i].AccSums;
            accPoss = accInfos[i].AccPoss;
            for (j in accSums) {
                if (accSums[j].Tag == "NetLiquidation")
                    totalNetLiquidation += Number(accSums[j].Value);    // ! assume accSums[j].Currency = "USD"
                if (accSums[j].Tag == "TotalCashValue")
                    totalCash += Number(accSums[j].Value);
                if (accSums[j].Tag == "InitMarginReq")
                    totalInitMarginReq += Number(accSums[j].Value);
                if (accSums[j].Tag == "MaintMarginReq")
                    totalMaintMarginReq += Number(accSums[j].Value);
                if (accSums[j].Tag == "GrossPositionValue")
                    totalGrossPosValue += Number(accSums[j].Value);
            }

            for (k in accPoss) {
                accPos = accPoss[k];
                if (accPos.Symbol == "VIX")      // we just don't want to see these. Not interested. Ignore it even from the table. Later, there could be a UI radiobox for this.
                    continue;

                localSymbol = "", estUnderyingPrice = "", ibComputedUndPrice = "", ibComputedDelta = "", deliveryValue = "", deltaAdjDeliveryValue = "";
                guessedBetaN = 1.0;
                betaDeltaAdjMktOrValN = NaN;
                estUnderyingPriceNum = 0.0, ibComputedUndPriceNum = 0.0;
                posN = Number(accPos.Pos);          // postfix N means Number type
                mktValueN = round(posN * Number(accPos.EstPrice));
                deliveryValueN = 0;
                deltaAdjDeliveryValueN = NaN;

                if (accPos.Symbol in betaArr)
                    guessedBetaN = betaArr[accPos.Symbol];

                if (accPos.SecType == "STK")
                    if (mktValueN > 0)
                        longStockValue += mktValueN;
                    else if (mktValueN < 0)  // so NaN is not added to any of them.
                        shortStockValue += mktValueN;

                avgCost = accPos.AvgCost;
                plN = round(posN * (Number(accPos.EstPrice) - Number(avgCost)));

                if (accPos.hasOwnProperty('LocalSymbol')) {
                    localSymbol = accPos.LocalSymbol;
                }
                if (accPos.hasOwnProperty('EstUnderlyingPrice')) {
                    estUnderyingPrice = accPos.EstUnderlyingPrice;
                    estUnderyingPriceNum = Number(estUnderyingPrice);
                }
                if (accPos.hasOwnProperty('IbComputedUndPrice')) {
                    ibComputedUndPrice = accPos.IbComputedUndPrice;
                    ibComputedUndPriceNum = Number(ibComputedUndPrice);
                }
                if (accPos.hasOwnProperty('IbComputedDelta')) {
                    ibComputedDelta = accPos.IbComputedDelta;
                }


                combinedUndPrice = estUnderyingPriceNum;
                if (isNaN(combinedUndPrice) || combinedUndPrice == 0.0)
                    combinedUndPrice = ibComputedUndPriceNum;

                if (accPos.SecType == "OPT" && !isNaN(combinedUndPrice) && combinedUndPrice != 0.0) {
                    optCallPutMulN = 1;
                    if (accPos.Right == "P")
                        optCallPutMulN = -1;
                    deliveryValueN = round(posN * optCallPutMulN * Number(accPos.Multiplier) * Number(combinedUndPrice));
                    deliveryValue = deliveryValueN.toLocaleString(undefined, { maximumFractionDigits: 0 });

                    deltaAdjDeliveryValueN = Math.abs(deliveryValueN) * ibComputedDelta;    // deliveryValueN can be negative, because of optCallPutMulN, and delta is also negative for Put options.
                    deltaAdjDeliveryValue = deltaAdjDeliveryValueN.toLocaleString(undefined, { maximumFractionDigits: 0 });
                }


                if (accPos.SecType == "OPT") {
                    if (deliveryValueN > 0)
                        longOptionValue += deliveryValueN;
                    else if (deliveryValueN < 0)    // so NaN is not added to any of them.
                        shortOptionValue += deliveryValueN;

                    if (deltaAdjDeliveryValueN > 0)
                        adjLongOptionValue += deltaAdjDeliveryValueN;
                    else if (deltaAdjDeliveryValueN < 0)    // so NaN is not added to any of them.
                        adjShortOptionValue += deltaAdjDeliveryValueN;
                }

                if (accPos.SecType == "STK") {
                    betaDeltaAdjMktOrValN =  guessedBetaN * mktValueN;
                } else if (accPos.SecType == "OPT") {
                    betaDeltaAdjMktOrValN =  guessedBetaN * deltaAdjDeliveryValueN; 
                }
                betaDeltaAdjTotalMarketOrientationN += betaDeltaAdjMktOrValN;
                totalMaxRiskedN += Math.abs(mktValueN);

                rowClass = "";
                if (plN > 3000) // if profit is bigger than 3K
                    rowClass = " class=\"secpri\"";
                if (accPos.EstPrice == 0.0) // if price is probably erroneous
                    rowClass += " bgcolor=\"#FF0000\" title=\"Likely error in price\"";

                deltaAdjDeliveryValue = isNaN(deltaAdjDeliveryValueN) ? "" : deltaAdjDeliveryValueN.toLocaleString(undefined, { maximumFractionDigits: 0 });
                betaDeltaAdjMktOrVal =  isNaN(betaDeltaAdjMktOrValN) ? "": betaDeltaAdjMktOrValN.toLocaleString(undefined, { maximumFractionDigits: 0 });
                brAccStr = (accInfos[i].BrAcc.length > 3) ? accInfos[i].BrAcc.substr(0, 3) : accInfos[i].BrAcc;

                posTableInner += "<tr" + rowClass + "><td>" + accPos.Symbol + "</td><td>" + localSymbol + "</td><td>" + accPos.Pos + "</td><td>" + avgCost + "</td><td>" + accPos.EstPrice + "</td><td>" + plN.toLocaleString() + "</td><td>" + mktValueN.toLocaleString() + "</td><td>" + estUnderyingPrice + "</td><td>" + ibComputedUndPrice + "</td><td>" 
                    + ibComputedDelta + "</td><td>" + deliveryValue + "</td><td>" + deltaAdjDeliveryValue + "</td><td>" 
                    + guessedBetaN + "</td><td>" + betaDeltaAdjMktOrVal + "</td><td>" +  brAccStr + "</td></tr>";
                //if (accPos.Symbol == "NetLiquidation")
                //    totalNetLiquidation += Number(accPos.Value);
            }

        }



        document.getElementById("idBrAccounts").innerHTML = brAccounts;
        document.getElementById("idTimestamp").innerHTML = timestamps;

        document.getElementById("idTotalNetLiquidation").innerHTML = round(totalNetLiquidation).toLocaleString();
        document.getElementById("idTotalCash").innerHTML = round(totalCash).toLocaleString();
        document.getElementById("idTotalInitMarginReq").innerHTML = round(totalInitMarginReq).toLocaleString();
        document.getElementById("idTotalMaintMarginReq").innerHTML = round(totalMaintMarginReq).toLocaleString();
        document.getElementById("idTotalGrossPosValue").innerHTML = round(totalGrossPosValue).toLocaleString();

        document.getElementById("idLongStockValue").innerHTML = round(longStockValue).toLocaleString();
        document.getElementById("idShortStockValue").innerHTML = round(shortStockValue).toLocaleString();
        document.getElementById("idGrossStockExposure").innerHTML = round(longStockValue + shortStockValue).toLocaleString();
        grossStockExposureLeverage = 0.0;
        if (totalNetLiquidation != 0.0)
            grossStockExposureLeverage = round(longStockValue + shortStockValue) / totalNetLiquidation;
        document.getElementById("idGrossStockExposureLeverage").innerHTML = grossStockExposureLeverage.toLocaleString();
        document.getElementById("idLongOptionValue").innerHTML = round(longOptionValue).toLocaleString();
        document.getElementById("idShortOptionValue").innerHTML = round(shortOptionValue).toLocaleString();

        document.getElementById("idAdjLongOptionValue").innerHTML = round(adjLongOptionValue).toLocaleString();
        document.getElementById("idAdjShortOptionValue").innerHTML = round(adjShortOptionValue).toLocaleString();
        document.getElementById("idAdjGrossOptionExposure").innerHTML = round(adjLongOptionValue + adjShortOptionValue).toLocaleString();

        document.getElementById("idTotalMarketOrientation").innerHTML = round(longStockValue + shortStockValue + adjLongOptionValue + adjShortOptionValue).toLocaleString();
        document.getElementById("idTotalMaxRisked").innerHTML = round(totalMaxRiskedN).toLocaleString();
        document.getElementById("idBetaDeltaAdjTotalMarketOrientation").innerHTML = round(betaDeltaAdjTotalMarketOrientationN).toLocaleString();

        document.getElementById("idPosTable").innerHTML = posTableInner;
        document.getElementById("idDebugInfoPre").innerHTML = JSON.stringify(accInfos);




        console.log("Script in Body2.");
        $('th').click(function () {  // need for table header click sorting
            var table = $(this).parents('table').eq(0)
            var rows = table.find('tr:gt(0)').toArray().sort(comparer($(this).index()))
            this.asc = !this.asc
            if (!this.asc) { rows = rows.reverse() }
            for (var i = 0; i < rows.length; i++) { table.append(rows[i]) }
        })
        function comparer(index) {
            return function (a, b) {
                var valA = getCellValue(a, index), valB = getCellValue(b, index)
                // thousand separator is not handled as numeric well, remove it and see if it is a number or not.
                valAA = valA.replace(new RegExp(",", 'g'), ""), valBB = valB.replace(new RegExp(",", 'g'), "");     // replace all with the 'g' global flag
                if ($.isNumeric(valAA))
                    valA = valAA;
                if ($.isNumeric(valBB))
                    valB = valBB;
                return $.isNumeric(valA) && $.isNumeric(valB) ? valA - valB : valA.localeCompare(valB)
            }
        }
        function getCellValue(row, index) { return $(row).children('td').eq(index).html() }
        console.log("Body is running...");
    </script>



</body>
</html>
